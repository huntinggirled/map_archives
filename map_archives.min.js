!function(k){"use strict";k("#header").css("position","relative"),k("#footer").css("position","relative"),k("body").append('<div id="screennavi"><div id="navitab"><a href="" onclick="$(\'#screennavi\').tabToggle();return false;">◇ 閉じる</a></div><div id="marker_div"><img src="img/indi.gif" alt="読み込み中..." width="10" height="10" /> 読み込み中...</div><div id="sort_div"><input id="sort1" type="radio" name="sort" onchange="$(\'#map_archives\').markerToggle();return false;" checked><a href="" onclick="$(\'#map_archives\').sortToggle();return false;">時間順</a> <input id="sort2" type="radio" name="sort" onchange="$(\'#map_archives\').markerToggle();return false;"><a href="" onclick="$(\'#map_archives\').sortToggle();return false;">距離順</a></div><div id="search_div"><input id="search_button" type="button" value="周辺を再検索" onclick="$(\'#map_archives\').markerToggle();return false;" disabled="disabled" /></div><div id="polyline_div"><input id="polyline" type="checkbox" onchange="$(\'#map_archives\').polylineToggle();return false;"> <a href="" onclick="document.getElementById(\'polyline\').checked=(document.getElementById(\'polyline\').checked)?false:true;$(\'#map_archives\').polylineToggle();return false;">ポリライン表示</a></div><div id="current_div"><input id="current_button" type="button" value="現在地に移動" onclick="$(\'#map_archives\').getCurrentPosition();return false;"></div><div><input id="screen" type="checkbox" onchange="$(\'#map_archives\').screenToggle();return false;"> <a href="" onclick="document.getElementById(\'screen\').checked=(document.getElementById(\'screen\').checked)?false:true;$(\'#map_archives\').screenToggle();return false;">全画面表示</a></div></div>'),k("#sort_div").hide(),k("#search_div").hide(),k("#polyline_div").hide(),k("#sidenavi").css("position","fixed").css("background","#cccccc").css("padding","5px").css("top","50%").css("right","0px").css("z-index","2000").css("opacity","0.9").css("filter","alpha(opacity=90)"),k("#screennavi").css("position","fixed").css("background","#cccccc").css("padding","5px").css("bottom","0px").css("right","0px").css("z-index","2000").css("opacity","0.9").css("filter","alpha(opacity=90)");var a=k("#map_archives"),e={zoom:13,center:new google.maps.LatLng(35.681597,139.766092),disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP},b=new google.maps.Map(document.getElementById("map_archives"),e),o=new google.maps.Polyline({path:new google.maps.MVCArray,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2});o.setMap(b);var s=0,l=new google.maps.InfoWindow({headerDisabled:!0}),c=new google.maps.Marker,d=new google.maps.MVCArray,g=new google.maps.MVCArray,t={width:a.css("width"),height:a.css("height"),zindex:a.css("z-index")},_="0-0",y=void 0,w=[];k("body").keydown(function(e){var t=k("#seq_marker").attr("seq")||void 0;t&&(37===event.which?a.slideMarker(++t):39===event.which&&a.slideMarker(--t))}),k.ajax({url:"<$mt:BlogURL$>archives_jsonp.php",dataType:"jsonp",callback:"callback",timeout:5e3}).done(function(e,t,i){w=e,a.loadMarker()}).fail(function(e,t,i){k("#marker_div").empty()}).always(function(e,t,i){}),k.fn.loadMarker=function(){var e=w.items,t=new Array,i=void 0,a=void 0;if(location.search)for(var r=(r=location.search).substring(1,r.length),n=new Array,n=r.split("&"),o=0;o<n.length;o++){var s=new Array,l=(s=n[o].split("="))[0],s=s[1];if("q"==l&&""!=s){a=new google.maps.LatLng(s.split(",")[0],s.split(",")[1]),y||(_="3-3");break}}k("#sort1").is(":checked")?e.sort(function(e,t){return e.datetime<t.datetime?1:-1}):e.sort(function(e,t){var i=b.getCenter(),a=i.lat(),r=i.lng(),i=a-e.lat,e=r-e.lng,e=Math.sqrt(Math.pow(i,2)+Math.pow(e,2)),a=a-t.lat,t=r-t.lng;return e-Math.sqrt(Math.pow(a,2)+Math.pow(t,2))});for(var c,d,g,p,h=0,o=0;o<e.length;o++)Object.keys(e[o]).length&&(""!=(c=e[o]).lat&&""!=c.lng&&(d=c.datetime.split(" ")[0].replace(/-0/g,"-")+" "+c.title,t[p=c.datetime.split("-")[0]+"-"+c.datetime.split("-")[1]]=+t[p]||0,t[p]++,g='<div id="seq_marker" seq="'+h+'" style="height:80px; width:200px; overflow:auto;">',g+='<div>[ <a href="" onclick="$(this).slideMarker('+(h+1)+');return false;">←</a> ] [ <a href="" onclick="$(this).slideMarker('+(h-1)+');return false;">→</a> ]</div>',g+='<a href="'+c.link+'" target="_blank"><img class="widget-img-thumb" src="'+c.thumbnail+'" height="45" width="45" alt="'+c.thumbnail+'" title="'+d+'" /></a>',g+='<a href="'+c.link+'" target="_blank" title="'+d+'">'+c.title+"</a><br />",g+="</div>",!_||"0-0"!=_&&"4-4"!=_&&"1-1"!=_&&_!=p&&"3-3"!=_||(p=new google.maps.LatLng(c.lat,c.lng),i=i||p,"3-3"==_?a.lat()==p.lat()&&a.lng()==p.lng()&&(k.createMarker(p,d,g,h++),1!=h||y||(k("title").append(": "+c.title),k(".archive-header").append(": "+c.title))):"0-0"==_&&10<=o||"4-4"==_&&100<=o||k.createMarker(p,d,g,h++))));if(b.panTo(i),k(this).focus(),!y){"3-3"==_&&0<h-1&&(k("title").append(" 他"+(h-1)+"件"),k(".archive-header").append(" 他"+(h-1)+"件"));var v,u="",m=0;for(v in t){var f=v.replace("-0","-");u+='<option value="'+v+'">'+f.split("-")[0]+"年"+f.split("-")[1]+"月（"+t[v]+"）</option>",m+=t[v]}y="",y+='<select onchange="$(this).markerToggle(this[this.selectedIndex].value);return false;">',a&&(y+='<option value="3-3">リンク地点</option>'),y+='<option value="0-0">直近10件</option>',y+='<option value="4-4">直近100件</option>',y+=u,y+='<option value="1-1">全マーク（'+m+'）</option><option value="2-2">全て削除</option></select>',k("#marker_div").empty().append(y)}_&&"3-3"==_?(a&&k.directMarker(a),k("#sort_div").hide("fast"),k("#search_div").hide("fast"),k("#polyline_div").hide("fast")):(k("#sort_div").show("fast"),k("#search_div").show("fast"),k("#polyline_div").show("fast"))},k.createMarker=function(e,t,i,a){var i=i,r=new google.maps.Marker({position:e,map:b,title:t,zIndex:a}),i={headerDisabled:!0,content:i,zIndex:1e4},n=new google.maps.InfoWindow(i);google.maps.event.addListener(r,"click",function(){return l.close(),c.getPosition()&&c.getPosition().equals(r.getPosition())&&c.getPosition().equals(r.getPosition())?(c=new google.maps.Marker,!1):(n.open(b,r),l=n,c=r,void k("#marker_div select").blur())}),k("#polyline").is(":checked")&&o.getPath().insertAt(s++,e),d.push(r),g.push(n)},k.fn.sortToggle=function(){k("#sort1").is(":checked")?(k("#sort2").prop("checked",!0),k("#search_button").attr("disabled",!1),k("#search_button").removeAttr("disabled")):(k("#sort1").prop("checked",!0),k("#search_button").attr("disabled",!0)),k(this).markerToggle()},k.fn.markerToggle=function(e){e&&(_=e),d.forEach(function(e,t){e.setMap(null)}),d.clear(),g.clear(),o.getPath().clear(),"2-2"!=_&&k(this).loadMarker()},k.fn.polylineToggle=function(){if(k("#polyline").is(":checked")){d.getLength()<=0&&k(this).loadMarker();for(var e=0;e<d.getLength();e++){var t=d.getAt(e).getPosition();o.getPath().insertAt(e+1,t)}}else o.getPath().clear()},k.fn.screenToggle=function(){var e;k("#screen").is(":checked")?(e=b.getCenter(),a.css("position","fixed"),a.css("top","0px"),a.css("left","0px"),a.css("width","100%"),a.css("height","100%")):(e=b.getCenter(),a.css("position","relative"),a.css("width",t.width),a.css("height",t.height)),google.maps.event.trigger(b,"resize"),b.panTo(e)},k.fn.tabToggle=function(){"0px"==k("#screennavi").css("right")?(k("#screennavi").animate({right:"-"+(k("#screennavi").width()-50)+"px",bottom:"-"+(k("#screennavi").height()-17)+"px"},200),k("#navitab a").text("◆ 開く")):(k("#screennavi").animate({right:"0px",bottom:"0px"},200),k("#navitab a").text("◇ 閉じる"))},k.fn.slideMarker=function(e){var t=d.getAt(0).getZIndex(),i=d.getAt(d.length-1).getZIndex();e<t?e=i:i<e&&(e=t);for(var a=0;a<d.length;a++)if(d.getAt(a).getZIndex()==e){l.close();var r=d.getAt(a),n=g.getAt(a);n.open(b,r),b.panTo(r.getPosition()),l=n,c=r;break}},k.directMarker=function(e){for(var t=0;t<d.length;t++)if(d.getAt(t).getPosition().lat()==e.lat()&&d.getAt(t).getPosition().lng()==e.lng()){l.close();var i=d.getAt(t),a=g.getAt(t);a.open(b,i),b.panTo(i.getPosition()),l=a,c=i;break}},k.fn.getCurrentPosition=function(){k("#current_button").attr("disabled",!0),k("#current_div").append(' <img src="img/indi.gif" alt="読み込み中..." width="10" height="10" />'),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){e=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);b.panTo(e),k("#current_button").attr("disabled",!1),k("#current_button").removeAttr("disabled"),k("#current_div > img").remove()},function(){k("#current_button").attr("disabled",!1),k("#current_button").removeAttr("disabled"),k("#current_div > img").remove()}):(k("#current_button").attr("disabled",!1),k("#current_button").removeAttr("disabled"),k("#current_div > img").remove())}}(jQuery);
