(function(a){a("#header").css("position","relative");a("#footer").css("position","relative");a("body").append('<div id="screennavi"><div id="navitab"><a href="" onclick="$(\'#screennavi\').tabToggle();return false;">\u25c7 \u9589\u3058\u308b</a></div><div id="marker_div"><img src="img/indi.gif" alt="\u8aad\u307f\u8fbc\u307f\u4e2d..." width="10" height="10" /> \u8aad\u307f\u8fbc\u307f\u4e2d...</div><div id="sort_div"><input id="sort1" type="radio" name="sort" onchange="$(\'#map_archives\').markerToggle();return false;" checked><a href="" onclick="$(\'#map_archives\').sortToggle();return false;">\u6642\u9593\u9806</a> <input id="sort2" type="radio" name="sort" onchange="$(\'#map_archives\').markerToggle();return false;"><a href="" onclick="$(\'#map_archives\').sortToggle();return false;">\u8ddd\u96e2\u9806</a></div><div id="search_div"><input id="search_button" type="button" value="\u5468\u8fba\u3092\u518d\u691c\u7d22" onclick="$(\'#map_archives\').markerToggle();return false;" disabled="disabled" /></div><div id="polyline_div"><input id="polyline" type="checkbox" onchange="$(\'#map_archives\').polylineToggle();return false;"> <a href="" onclick="document.getElementById(\'polyline\').checked=(document.getElementById(\'polyline\').checked)?false:true;$(\'#map_archives\').polylineToggle();return false;">\u30dd\u30ea\u30e9\u30a4\u30f3\u8868\u793a</a></div><div id="current_div"><input id="current_button" type="button" value="\u73fe\u5728\u5730\u306b\u79fb\u52d5" onclick="$(\'#map_archives\').getCurrentPosition();return false;"></div><div><input id="screen" type="checkbox" onchange="$(\'#map_archives\').screenToggle();return false;"> <a href="" onclick="document.getElementById(\'screen\').checked=(document.getElementById(\'screen\').checked)?false:true;$(\'#map_archives\').screenToggle();return false;">\u5168\u753b\u9762\u8868\u793a</a></div></div>');
a("#sort_div").hide();a("#search_div").hide();a("#polyline_div").hide();a("#sidenavi").css("position","fixed").css("background","#cccccc").css("padding","5px").css("top","50%").css("right","0px").css("z-index","2000").css("opacity","0.9").css("filter","alpha(opacity=90)");a("#screennavi").css("position","fixed").css("background","#cccccc").css("padding","5px").css("bottom","0px").css("right","0px").css("z-index","2000").css("opacity","0.9").css("filter","alpha(opacity=90)");var d=a("#map_archives"),
y={zoom:13,center:new google.maps.LatLng(35.681597,139.766092),disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP},l=new google.maps.Map(document.getElementById("map_archives"),y),u=new google.maps.Polyline({path:new google.maps.MVCArray,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2});u.setMap(l);var z=0,t=new google.maps.InfoWindow,m=new google.maps.Marker,c=new google.maps.MVCArray,v=new google.maps.MVCArray,w={width:d.css("width"),height:d.css("height"),zindex:d.css("z-index")},
h="0-0",n=void 0,x=[];a("body").keydown(function(b){(b=a("#seq_marker").attr("seq")||void 0)&&(37===event.which?d.slideMarker(++b):39===event.which&&d.slideMarker(--b))});a.ajax({url:"<$mt:BlogURL$>archives_jsonp.php",dataType:"jsonp",callback:"callback",timeout:5E3}).done(function(a,f,c){x=a;d.loadMarker()}).fail(function(b,f,c){a("#marker_div").empty()}).always(function(a,f,c){});a.fn.loadMarker=function(){var b=x.items,f=[],c=void 0,d=void 0;if(location.search)for(var e=location.search,e=e.substring(1,
e.length),k=[],k=e.split("&"),e=0;e<k.length;e++){var g=[],g=k[e].split("="),r=g[1];if("q"==g[0]&&""!=r){d=new google.maps.LatLng(r.split(",")[0],r.split(",")[1]);n||(h="3-3");break}}a("#sort1").is(":checked")?b.sort(function(a,b){return a.datetime<b.datetime?1:-1}):b.sort(function(a,b){var f=l.getCenter(),c=f.lat(),f=f.lng();return Math.sqrt(Math.pow(c-a.lat,2)+Math.pow(f-a.lng,2))-Math.sqrt(Math.pow(c-b.lat,2)+Math.pow(f-b.lng,2))});for(e=k=0;e<b.length;e++)if(Object.keys(b[e]).length&&(g=b[e],
""!=g.lat&&""!=g.lng)){var r=g.datetime.split(" ")[0].replace(/-0/g,"-")+" "+g.title,p=g.datetime.split("-")[0]+"-"+g.datetime.split("-")[1];f[p]=+f[p]||0;f[p]++;var q='<div id="seq_marker" seq="'+k+'" style="height:80px; width:200px; overflow:auto;">',q=q+('<div>[ <a href="" onclick="$(this).slideMarker('+(k+1)+');return false;">\u2190</a> ] [ <a href="" onclick="$(this).slideMarker('+(k-1)+');return false;">\u2192</a> ]</div>'),q=q+('<a href="'+g.link+'" target="_blank"><img class="widget-img-thumb" src="'+
g.thumbnail+'" height="45" width="45" alt="'+g.thumbnail+'" title="'+r+'" /></a>'),q=q+('<a href="'+g.link+'" target="_blank" title="'+r+'">'+g.title+"</a><br />"),q=q+"</div>";!h||"0-0"!=h&&"4-4"!=h&&"1-1"!=h&&h!=p&&"3-3"!=h||(p=new google.maps.LatLng(g.lat,g.lng),c||(c=p),"3-3"==h?d.lat()==p.lat()&&d.lng()==p.lng()&&(a.createMarker(p,r,q,k++),1!=k||n||(a("title").append(": "+g.title),a(".archive-header").append(": "+g.title))):"0-0"==h&&10<=e||"4-4"==h&&100<=e||a.createMarker(p,r,q,k++))}l.panTo(c);
a(this).focus();if(!n){"3-3"==h&&0<k-1&&(a("title").append(" \u4ed6"+(k-1)+"\u4ef6"),a(".archive-header").append(" \u4ed6"+(k-1)+"\u4ef6"));var b="",c=0,m;for(m in f)e=m.replace("-0","-"),b+='<option value="'+m+'">'+e.split("-")[0]+"\u5e74"+e.split("-")[1]+"\u6708\uff08"+f[m]+"\uff09</option>",c+=f[m];n="";n+='<select onchange="$(this).markerToggle(this[this.selectedIndex].value);return false;">';d&&(n+='<option value="3-3">\u30ea\u30f3\u30af\u5730\u70b9</option>');n+='<option value="0-0">\u76f4\u8fd110\u4ef6</option>';
n+='<option value="4-4">\u76f4\u8fd1100\u4ef6</option>';n+=b;n+='<option value="1-1">\u5168\u30de\u30fc\u30af\uff08'+c+'\uff09</option><option value="2-2">\u5168\u3066\u524a\u9664</option></select>';a("#marker_div").empty().append(n)}h&&"3-3"==h?(d&&a.directMarker(d),a("#sort_div").hide("fast"),a("#search_div").hide("fast"),a("#polyline_div").hide("fast")):(a("#sort_div").show("fast"),a("#search_div").show("fast"),a("#polyline_div").show("fast"))};a.createMarker=function(b,f,d,h){var e=new google.maps.Marker({position:b,
map:l,title:f,zIndex:h}),k=new google.maps.InfoWindow({content:d,zIndex:1E4});google.maps.event.addListener(e,"click",function(){t.close();if(m.getPosition()&&m.getPosition().equals(e.getPosition())&&m.getPosition().equals(e.getPosition()))return m=new google.maps.Marker,!1;k.open(l,e);t=k;m=e;a("#marker_div select").blur()});a("#polyline").is(":checked")&&u.getPath().insertAt(z++,b);c.push(e);v.push(k)};a.fn.sortToggle=function(){a("#sort1").is(":checked")?(a("#sort2").prop("checked",!0),a("#search_button").attr("disabled",
!1),a("#search_button").removeAttr("disabled")):(a("#sort1").prop("checked",!0),a("#search_button").attr("disabled",!0));a(this).markerToggle()};a.fn.markerToggle=function(b){b&&(h=b);c.forEach(function(a,b){a.setMap(null)});c.clear();v.clear();u.getPath().clear();"2-2"!=h&&a(this).loadMarker()};a.fn.polylineToggle=function(){if(a("#polyline").is(":checked")){0>=c.getLength()&&a(this).loadMarker();for(var b=0;b<c.getLength();b++){var f=c.getAt(b).getPosition();u.getPath().insertAt(b+1,f)}}else u.getPath().clear()};
a.fn.screenToggle=function(){if(a("#screen").is(":checked")){var b=l.getCenter();d.css("position","fixed");d.css("top","0px");d.css("left","0px");d.css("width","100%");d.css("height","100%")}else b=l.getCenter(),d.css("position","relative"),d.css("width",w.width),d.css("height",w.height);google.maps.event.trigger(l,"resize");l.panTo(b)};a.fn.tabToggle=function(){"0px"==a("#screennavi").css("right")?(a("#screennavi").animate({right:"-"+(a("#screennavi").width()-50)+"px",bottom:"-"+(a("#screennavi").height()-
17)+"px"},200),a("#navitab a").text("\u25c6 \u958b\u304f")):(a("#screennavi").animate({right:"0px",bottom:"0px"},200),a("#navitab a").text("\u25c7 \u9589\u3058\u308b"))};a.fn.slideMarker=function(a){var b=c.getAt(0).getZIndex(),d=c.getAt(c.length-1).getZIndex();a<b?a=d:d<a&&(a=b);for(b=0;b<c.length;b++)if(c.getAt(b).getZIndex()==a){t.close();a=c.getAt(b);b=v.getAt(b);b.open(l,a);l.panTo(a.getPosition());t=b;m=a;break}};a.directMarker=function(a){for(var b=0;b<c.length;b++)if(c.getAt(b).getPosition().lat()==
a.lat()&&c.getAt(b).getPosition().lng()==a.lng()){t.close();a=c.getAt(b);b=v.getAt(b);b.open(l,a);l.panTo(a.getPosition());t=b;m=a;break}};a.fn.getCurrentPosition=function(){a("#current_button").attr("disabled",!0);a("#current_div").append(' <img src="img/indi.gif" alt="\u8aad\u307f\u8fbc\u307f\u4e2d..." width="10" height="10" />');navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){b=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);l.panTo(b);a("#current_button").attr("disabled",
!1);a("#current_button").removeAttr("disabled");a("#current_div > img").remove()},function(){a("#current_button").attr("disabled",!1);a("#current_button").removeAttr("disabled");a("#current_div > img").remove()}):(a("#current_button").attr("disabled",!1),a("#current_button").removeAttr("disabled"),a("#current_div > img").remove())}})(jQuery);
